#!/bin/sh -u
typeset APPLDIR=$( cd `dirname $0`;pwd )          # スクリプト格納場所
typeset BASEDIR=$( dirname $APPLDIR )             # スクリプト格納場所

typeset RunShell=$1                               # スクリプト名
shift

RunShell=${RunShell%.sh}
typeset LOGFILE="$BASEDIR/logs/$RunShell.log"     # ログファイル
typeset TMPFILE="$BASEDIR/temp/$RunShell.tmp"     # 一時ファイル
typeset RTNFILE="$BASEDIR/temp/$RunShell.rtn"     # RTNファイル

##
cd $APPLDIR
(
	: > $TMPFILE
	./$RunShell.sh "${@:-}"
	echo "$?" > $RTNFILE
) 2>&1 | ( 
	while read;do
		if [[ "$REPLY" != *'set +x' ]];then
			echo "$(date '+%Y/%m/%d %H:%M:%S') $REPLY"
		fi
	done
) | tee $LOGFILE

rm -f $TMPFILE
#
typeset -i RTN=$( cat $RTNFILE )
if (( $RTN == 0 ));then
	echo "OK"
	rm -f $RTNFILE
	exit
else
	echo "NG return $RTN"
	rm -f $RTNFILE
	exit $RTN
fi
